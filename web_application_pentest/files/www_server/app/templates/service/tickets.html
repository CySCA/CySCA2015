{% extends 'intranet.html' %} 

{% block box %}
<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#inbox">Open Tickets</a></li>
  <li><a data-toggle="tab" href="#submit">Submit Ticket</a></li>
</ul>

<div class="tab-content">

  <div id="inbox" class="tab-pane fade in active">
    <table class="table mail-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Opened</th>
        </tr>
      </thead>
      <tbody id="ticketTable">
      </tbody>
    </table>
  </div>

  <div id="submit" class="tab-pane fade in">
    <form id="ticket-form" method="POST" class="form-horizontal" role="form">
      <div class="form-group">
        <label class="control-label col-sm-2" for="title">Title:</label>
        <div class="col-sm-10">
          <input id="ticketTitle" type="text" class="form-control" name="title" placeholder="Issue title">
        </div>
      </div>
      <div class="form-group">
        <textarea id="ticketIssue" class="form-control compose-textarea" rows="10" name="issue" placeholder="Enter message"></textarea>
      </div>
      <div class="form-group center">
        <button type="submit" class="btn btn-default">Submit</button>
      </div>
    </form>
  </div>

</div>
{% endblock %}

{% block xscript %}
<script>
  $(document).ready(function() {
    get_tickets("{{ user.id }}", "{{ user.ticket_secret }}")
    .done(function(data) {
      tickets = data['tickets'];
      for (i=0; i < tickets.length; i++) {
        cls = "clickable-row mail-row";
        link = "/service/ticket/" + tickets[i].id;
        var row = $('<tr class="' + cls + '" data-href="' + link +'">');
        row.append($("<td>").text(tickets[i]['title']));
        row.append($("<td>").text(tickets[i]['status']));
        row.append($("<td>").text(tickets[i]['timestamp']));
        $('#ticketTable').append(row);
      };
    }).then(function() {          
      $(".clickable-row").click(function() {
        window.document.location = $(this).data("href");
      });
    });

    $('form#ticket-form').submit(function(event) {
      event.preventDefault();
      add_ticket("{{ user.id }}", "{{ user.ticket_secret }}",
          $('#ticketTitle').val(), $('#ticketIssue').val());
    });
  });
</script>
{% endblock %}
