#!/usr/bin/python
"""
A Python challenge that unpickles user input, with some caveats.
"""
import pickle
import pickletools
import sys

denylist = ("system","exec","popen","print")

def pickle_filtered(value):
    """ Unpickle a string, but reject certain inputs.

    Specifically, only built-in class objects and functions are
    allowed.
    """
    for opcode, arg, _ in pickletools.genops(value):
        if (opcode.code in [pickle.GLOBAL, pickle.INST]
            and not arg.startswith('__builtin__')):
            raise ValueError('Only built-in functions/classes allowed.')
    pickle.loads(value)

def main():
    """ This module's main entry point: pickle data from stdin.
    """
    print 'Give me pickled commands to get the flag.'
    print 'Enter "DONE" on a new line to end input'
    
    buffer = [] 
    while True:
    	userinput = sys.stdin.readline().lstrip()
    	if userinput == 'DONE\n':
        	break
    	else:
        	buffer.append(userinput)
    user_input = ''.join(buffer)
    
    for item in denylist:
        if item in user_input.lower():
             print "%s not allowed"%item
             sys.exit() 
    pickle_filtered(user_input)

if __name__ == '__main__':
    main()

