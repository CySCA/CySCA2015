var b64_table = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

function b64_decode(data) {
  var o1, o2, o3, h1, h2, h3, h4, bits, i = 0, result = [];
  if (!data) { return data; }
  data += "";
  do {
    h1 = b64_table.indexOf(data.charAt(i++));
    h2 = b64_table.indexOf(data.charAt(i++));
    h3 = b64_table.indexOf(data.charAt(i++));
    h4 = b64_table.indexOf(data.charAt(i++));
    bits = h1 << 18 | h2 << 12 | h3 << 6 | h4;
    o1 = bits >> 16 & 0xff;
    o2 = bits >> 8 & 0xff;
    o3 = bits & 0xff;
    result.push(o1);
    if (h3 !== 64) {
      result.push(o2);
      if (h4 !== 64) {
        result.push(o3);
      }
    }
  } while (i < data.length);
  return result;
}

function make_me_safe(html) {
  var tmp = document.createElement("div");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}

function mail_decrypt(key, msg) {
  p = '';
  c = b64_decode(msg);
  for (i=0; i<c.length; i++) {
    p += String.fromCharCode(key.charCodeAt(i % key.length) ^ c[i]); 
  }
  return p;
}

function get_tickets(uid, secret) {
  return $.ajax({
    method: "POST",
    url: "http://support.ecwi.cysca/ticket/get",
    dataType: "json",
    crossDomain: true,
    contentType: "application/json; charset=utf-8",
    data: JSON.stringify({
      uid: uid,
      secret: secret
    })
  });
}

function get_ticket(uid, secret, id) {
  return $.ajax({
    method: "POST",
    url: "http://support.ecwi.cysca/ticket/get/" + id,
    dataType: "json",
    crossDomain: true,
    contentType: "application/json; charset=utf-8",
    data: JSON.stringify({
      uid: uid,
      secret: secret
    })
  });
}

function add_ticket(uid, secret, title, issue) {
  return $.ajax({
    method: "POST",
    url: "http://support.ecwi.cysca/ticket/new",
    dataType: "json",
    crossDomain: true,
    contentType: "application/json; charset=utf-8",
    data: JSON.stringify({
      uid: uid,
      secret: secret,
      title: title,
      issue: issue
    })
  }).then(function() {
    window.location.reload();
  });
}

function reply_ticket(uid, secret, id, author, message) {
  return $.ajax({
    method: "POST",
    url: "http://support.ecwi.cysca/ticket/reply/" + id,
    dataType: "json",
    crossDomain: true,
    contentType: "application/json; charset=utf-8",
    data: JSON.stringify({
      uid: uid,
      secret: secret,
      author: author,
      message: message
    })
  }).then(function() {
    window.location.reload();
  });
}
