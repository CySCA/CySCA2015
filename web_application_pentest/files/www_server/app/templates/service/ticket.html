{% extends 'intranet.html' %} 

{% block box %}
<div class="ticket-container">
  <div class="ticket">
    <div id="ticketTimestamp" class="ticket-timestamp"></div>
    <div id="ticketTitle" class="ticket-title"></div> 
    <div id="ticketIssue" class="ticket-issue"></div>
  </div>
  <div id="replyTable" class="ticket-replies">
  </div>
  <form id="ticket-form" method="POST" class="form-horizontal" role="form">
    <div class="form-group">
      <textarea id="replyMessage" class="form-control compose-reply" rows="10" name="message" placeholder="Enter message"></textarea>
    </div>
    <div class="form-group center">
      <button type="submit" class="btn btn-default">Reply</button>
    </div>
  </form>
</div>
{% endblock %}

{% block xscript %}
<script>
  $(document).ready(function() {
    get_ticket("{{ user.id }}", "{{ user.ticket_secret }}", "{{ ticket_id }}")
    .then(function(data) {
      ticket = data['ticket'][0]; 
      document.getElementById('ticketTitle').innerHTML=ticket['title'];
      document.getElementById('ticketIssue').innerHTML=ticket['issue'];
      document.getElementById('ticketTimestamp').innerHTML=ticket['timestamp'];
      replies = ticket['replies'];
      for (i=0; i < replies.length; i++) {
        t = $('#replyTable');
        t.append($("<div class='reply-timestamp'>").text(replies[i]['timestamp']));
        t.append($("<div class='reply-user'>").text(replies[i]['author']));
        t.append($("<div class='reply-message'>").text(replies[i]['message']));
      }
    });

    $('form#ticket-form').submit(function(event) {
      event.preventDefault();
      reply_ticket("{{ user.id }}", "{{ user.ticket_secret }}",
          {{ ticket_id }}, "{{ user.name }}", $('#replyMessage').val());
    });
  });
</script>
{% endblock %}
