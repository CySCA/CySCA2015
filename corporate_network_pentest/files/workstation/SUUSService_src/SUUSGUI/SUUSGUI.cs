using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace SUUSGUI
{
    public partial class SUUSGUI : Form
    {
        private const String TRIGGER_EVENT_NAME = "Global\\SoftwareUpdateService_CYSCA_UpdateCheck";

        public SUUSGUI()
        {
            InitializeComponent();
        }

        private void SUUSGUI_FormClosing(object sender, FormClosingEventArgs e)
        {
            this.Visible = false;
            e.Cancel = true;
        }

        private void ntfySUSGUI_MouseDoubleClick(object sender, MouseEventArgs e)
        {
            this.Visible = true;
        }

        private void ntfySUSGUI_MouseClick(object sender, MouseEventArgs e)
        {
            this.Visible = true;
        }

        private void tmrHide_Tick(object sender, EventArgs e)
        {
            this.Visible = false;
            tmrHide.Stop();
        }

        private void SUUSGUI_Load(object sender, EventArgs e)
        {
            tmrHide.Start();
        }

        private void btnUpdateCheck_Click(object sender, EventArgs e)
        {
            //Try get a handle to the event
            btnUpdateCheck.Enabled = false;
            tmrUpdateReq.Start();
            textStatus.Text = "Attempting to trigger a check for software updates by the service";

            textStatus.Text = "Opening global update trigger";
            EventWaitHandle ewh;
            try
            {
                ewh = EventWaitHandle.OpenExisting(TRIGGER_EVENT_NAME);
            }
            catch (Exception ex)
            {
                textStatus.Text = "ERROR: Unable to open update trigger event. Try restarting this VM, if it continues contact EXCON";
                MessageBox.Show(ex.ToString());
                return;
            }

            textStatus.Text = "Triggering an update check";
            try
            {
                ewh.Set();
                ewh.Close();
                textStatus.Text = "Update Triggered.";
            }
            catch (ObjectDisposedException ex)
            {
                textStatus.Text = "ERROR: An error occurred when trying to trigger the update. Try restarting this VM, if it continues contact EXCON";
                MessageBox.Show(ex.ToString());
            }
            return;
        }

        private void tmrUpdateReq_Tick(object sender, EventArgs e)
        {
            btnUpdateCheck.Enabled = true;
            tmrUpdateReq.Stop();
        }
    }
}
