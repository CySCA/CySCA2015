var casper = require('casper').create({
    verbose: true,
    logLevel: 'debug'
});

casper.userAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X)');

casper.on('error', function(msg,backtrace) {
  this.echo("=========================");
  this.echo("ERROR:");
  this.echo(msg);
  this.echo(backtrace);
  this.echo("=========================");
});

casper.on("page.error", function(msg, backtrace) {
  this.echo("=========================");
  this.echo("PAGE.ERROR:");
  this.echo(msg);
  this.echo(backtrace);
  this.echo("=========================");
});

casper.start('http://ecwi.cysca/login', function() {
    this.fill('form#loginform', {
      'email':'angelina.magoffin@ecwi.com',
      'password':'#ang3lfr0mh34v3n~c3o1337'
    }, true);
    this.click("form#loginform button[id='Login']");
});

casper.then(function() {
  this.repeat(4, function() {
    this.open('http://ecwi.cysca/service/#manage').then(function() {
      btnLinks = this.evaluate(function(){
        var links = document.getElementsByClassName('btn-deny');
        links = Array.prototype.map.call(links,function(link){
          return link.getAttribute('href');
        });
        return links;
      });
      this.each(btnLinks,function(self,link) {
        this.open('http://ecwi.cysca/service/' + link);
        this.wait(1000);
      });
      this.wait(60000);
    });
  });
});

casper.run(function() {
  this.exit();
});
