//SUID root exploit
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>

//DNS Updater
char* validate_domain(char* domain)
{
	if( strcmp("ecwi.cysca", domain) != 0)
	{
		printf("Although it works for more domains, our DNS server is only responsible for ecwi.cysca - Jeremy\n");
		return NULL;
	}
	//Make a copy of the domain
	return strdup(domain);
}

char* validate_hostname(char* hostname)
{
	int i=0;
	//Check that the hostname entry is valid. I.e. contains no .'s and contains valid chars. otherwise bail.
	if (strchr(hostname,'.') != NULL)
	{
		printf("Hostname cannot contain a . character\n");
		return NULL;
	}

	for(i=0;i<strlen(hostname);i++)
	{
		if( isalnum(hostname[i]) == 0)
		{
			printf("Invalid character '%c' in hostname\n",hostname[i]);
			return NULL;
		}
	}

	return strdup(hostname);
}

char* validate_ip(char* ip)
{
	char parts[4][10];
    int i,x;
    char* parseip = strdup(ip);

	for(i=0;i<strlen(parseip);i++)
	{
			if( parseip[i] == '.')
				parseip[i] = ' ';
	}

	//BUG: scanf or strcpy into a limited size buffers.
	int numparts = sscanf(parseip, "%s %s %s %s", parts[0], parts[1], parts[2], parts[3]);
	if(numparts != 4)
	{
		printf("ip address %s is invalid\n", ip);
		return NULL;
	}

	//Validate that the parts are numbers. otherwise bail
	for(i=0;i<4;i++)
	{
		for(x=0;x<strlen(parts[i]);x++)
		{
			if(isdigit(parts[i][x]) == 0)
			{
					printf("ip address part %d is invalid\n", i+1);
					return NULL;
			}
		}

		if(atoi(parts[i]) < 0 || atoi(parts[i]) > 255)
		{
			printf("ip address part %d is invalid\n", i+1);
			return NULL;
		}
	}

	//All seems valid here. duplicate the supplied ip.
	return strdup(ip);
}

int add_host_entry(char* domain, char* hostname, char* ipaddress)
{
    //Look for the domain zone file. If it doesn't exist exit.
	FILE* hostfile = fopen("/etc/bind/db.ecwi.cysca","r+");
    if (hostfile == NULL)
        return -6913;

    //Append the line to the bottom of the hosts file
    fseek(hostfile,0,SEEK_END);
	printf("%s\tA\t%s\n",hostname,ipaddress);
	fprintf(hostfile,"%s\tA\t%s\n",hostname,ipaddress);

	fclose(hostfile);
}

void print_usage()
{
	printf("ECWI Secure DNS Updater\n");
	printf("Written by Jeremy Amadio\n");
	printf("Usage: dns-update [hosteddomain] [hostname] [ip]\n");
	printf("\t hosteddomain - The name of the domain that the host should be added to. Should always be ecwi.cysca\n");
	printf("\t hostname - The name of the A record to be added\n");
	printf("\t ip - The IPv4 address that the A record should include\n");
}

int reload_bind_config()
{
	//Reload the bind config and check the return value
	int err = system("/etc/init.d/bind9 reload");
	//int err = system("true");

	if (err != 0)
	{
		printf("An error occurred during reload of bind config. Error was %d\n",err);
		return err;
	}

	return 0;
}

int main(int argc, char* argv[])
{
	//Check for number of args
	if (argc != 4)
	{
		printf("You need to have the right number of params in the command line\n");
		print_usage();
		return -1;
	}

	//Validate domain
	char* domain = validate_domain(argv[1]);
	if (domain == NULL)
	{
		printf("The domain name is invalid\n");
		return -2;
	}

	//Validate hostname
	char* hostname = validate_hostname(argv[2]);
	if (hostname == NULL)
	{
		printf("The hostname is invalid\n");
		free(domain);
		return -3;
	}

	//Validate ip
	char* ip = validate_ip(argv[3]);
	if (ip == NULL)
	{
		printf("The ip is invalid\n");
		free(domain); 
		free(hostname);
		return -4;
	}
	
    //Add the entry to the dns file and restart bind
	int err = add_host_entry(domain, hostname, ip);
	free(domain);
	free(hostname);
	free(ip);
	if (err != 0)
	{
		printf("Adding host entry to domain failed. Error %d.\n", err);
        return -5;
	}
	else
	{
		printf("Successfully added host entry to bind. Reloading Bind\n");
		err = reload_bind_config();
		if (err != 0)
		{
            return -6;
		}else{
			printf("Bind reloaded successfully\n");
            return 0;
		}
	}

}
